<div id="geomap" class="carte_gis"></div>

<script type="text/javascript">
<!--
(function($){
	$(function(){

		// <BOUCLE_gis(GIS){id_article}>
		// centrer sur l'article passe dans l'url
		// #SET{lat,#LAT} #SET{lon,#LON} #SET{zoom,#ZOOM}
		// </BOUCLE_gis>
		[(#REM) Sinon centrer sur les coordonnes passees en parametre ou sur celle par defaut ]
		[(#GET{lat}|non)
		#SET{lat,#ENV{lat,#CONFIG**{gis/lat,0}}}]
		[(#GET{lon}|non)
		#SET{lon,#ENV{lon,#CONFIG**{gis/lon,0}}}]
		[(#GET{zoom}|non)
		#SET{zoom, #ENV{zoom,#CONFIG**{gis/zoom,0}}]
		
		var infowindow;
		var layers = new Array();

		var parseData = function(data,map) {
			markers = [];
			$.each(data.features, function(i,item){
				if (item.geometry.coordinates[0]) {
					var latlng = new L.LatLng(item.geometry.coordinates[1],item.geometry.coordinates[0]);
					var marker = new L.Marker(latlng);
					if (item.properties.icon) {
						marker.setIcon(new L.Icon({
							iconUrl: item.properties.icon,
							iconSize: new L.Point(32,32),
							iconAnchor: new L.Point(16,16),
						}));
					}
					marker.id = item.id;
					markers.push(marker);
				}
			});
			
			markerCluster = new L.Marker.Clusterer(map, markers, {
				maxZoom: 50, // on veut des clusters quel que soit le zoom pour ouvrir les infowindows paginées
				styles: [{
					url: '#CHEMIN{images/bg_cluster.png}',
					height: 40,
					width: 40,
					opt_textColor: '#ffffff'
				}]
			});
			
			// préparer les infowindows
			var infowindow_options = {
				//closeBoxURL: '[(#CHEMIN{images/infowindow_close.png})]',
				className: 'geol_window',
				maxWidth: 350
			};
			infowindow = new L.Popup(infowindow_options);
			var extUrl = "[(#URL_PAGE{get_infowindow})]";
			
			var get_infowindow = function(url,ids,infowindow,marker,map) {
				$.ajax({
					url: url,
					data: { id_article : ids },
					success: function(data){
						infowindow.setContent(data);
						infowindow.setLatLng(marker._latlng);
						map.openPopup(infowindow);
					}
				});
			};
			
			$.each(markers,function(i,marker){
				[// ouvrir l'infowindow du marker passé dans l'url
				if (marker.id=='(#ENV{id_article})') {
					get_infowindow(extUrl,#ENV{id_article},infowindow,marker,map);
				}]
				marker.addEventListener('click', function() {
					get_infowindow(extUrl,marker.id,infowindow,marker,map);
				});
			});
			// lors du  clic sur un cluster
			markerCluster.addEventListener('click', function (e) {
				var markers = e.cluster.getMarkers();
				if (markers.length > 1) {
					// si on est au zoom maxi de la carte
					if (map.getMaxZoom() <= map.getZoom()) {
						// récupérer les id des markers du cluster
						var markers_ids = new Array();
						$.each(markers,function(i,marker){
							markers_ids.push(marker.marker.id);
						});
						// ouvrir une infowindow multiple
						get_infowindow(extUrl,markers_ids,infowindow,e.cluster._clusterMarker,map);
					}
				}
				return false;
			});
		};

		var initMap = function() {
			var map_container = 'geomap';
			map = new L.Map(map_container,{
				zoomControl: false,
				maxZoom: 21 // on fixe un zoom max arbitraire en attendant que les couches le renseignent
			});
			map.setView(new L.LatLng([(#GET{lat})], [(#GET{lon})]), [(#GET{zoom})]);

			//default layer
			#SET{layer_defaut,#REM|gis_layer_defaut} #SET{layers,#EVAL{$GLOBALS['gis_layers']}}
			var [(#GET{layer_defaut})] = [new (#GET{layers}|table_valeur{#GET{layer_defaut}/layer})];
			map.addLayer([(#GET{layer_defaut})]);
			
			<B_layers>
			// on colle le control de layers à gauche en mode toujours ouvert
			var layers_control = new L.Control.Layers('','',{position: 'topleft', collapsed: false});
			layers_control.addBaseLayer([(#GET{layer_defaut})],["(#GET{layers}|table_valeur{#GET{layer_defaut}/nom})"]);
			<BOUCLE_layers(DATA){source table, #GET{layers}}{si #ENV{control_type,#ENV{controle_type}}|!={non}|et{#ENV{no_control,#ENV{aucun_controle}}|!={oui}}|et{#CONFIG{gis/layers,#ARRAY}|count|>{1}|oui}|oui}>[
			(#CLE|!={#GET{layer_defaut}}|oui|et{#CLE|in_array{#CONFIG{gis/layers,#ARRAY}}|oui}|oui)
			layers_control.addBaseLayer([new (#VALEUR|table_valeur{layer})],"[(#VALEUR|table_valeur{nom})]");]
			</BOUCLE_layers>
			map.addControl(layers_control);
			// classe noajax sur le layer_control pour éviter l'ajout de hidden par SPIP
			$(layers_control._form).addClass('noajax');
			</B_layers>

			map.attributionControl.setPrefix('');
			
			map.addControl(new L.Control.Scale());
			map.addControl(new L.Control.Zoom());
			map.addControl(new L.Control.FullScreen());

			// fermer l'infowindow au chagenement de zoom
			map.on('zoomend', function(e) {
				if (infowindow) infowindow._close();
			});
			
			// <BOUCLE_kml(ARTICLES documents_liens documents){id_article}{documents.mode=document}{documents.extension IN 'kml','kmz'}>
			// superposer le kml de l'article passe en url
			layers['kml_#ID_ARTICLE'] = new L.KML("[(#URL_DOCUMENT|url_absolue)]", {async: true});
			map.addLayer(layers['kml_#ID_ARTICLE']);
			#SET{kml,oui}
			// </BOUCLE_kml>
			
			// charger les markers sauf si on superpose un kml
			[(#GET{kml}|non)
			$.getJSON("#PRODUIRE{fond=geol_markers.json,id_auteur=#ENV{id_auteur},id_mot=#ENV{id_mot},id_rubrique=#ENV{id_rubrique}}",
				function(data) {
					if (data){
						parseData(data,map);
					}
				}
			);
			]
			
			[(#ENV{id_auteur}|oui|ou{#ENV{id_mot}|oui}|ou{#ENV{id_rubrique}|ou{#GET{kml}|oui}|oui})
			// carte filtree
			infoFilter();
			]
			
			// palcer le panel des kmls dans un bloc de control pour ne pas le perdre en fullscreen
			map._controlCorners.topright.appendChild(L.DomUtil.get('kml_panel'));
			
		};
		
		// resize la carte si chgt de taille sur window
		var resizeMap = function() {
			var top_h = $('#top').height();
			var page_h = $('#page').height();
			$('#geomap').height(page_h - top_h);
		};
		
		// afficher un message si la carte est filtrée sur un ou plusieurs id
		var infoFilter = function() {
			var close_filtre = '<a href="#URL_PAGE{carte}" id="close_filtre" title="<:geol:recherche_retirer_filtre|attribut_html:>"><:geol:annuler:></a>';
			var filtre = new Array();
			[filtre.push('#INFO_NOM{auteur,#ENV{id_auteur}}');(#ENV{id_auteur}|oui)]
			[filtre.push('#INFO_TITRE{mot,#ENV{id_mot}}');(#ENV{id_mot}|oui)]
			[filtre.push('#INFO_TITRE{rubrique,#ENV{id_rubrique}}');(#ENV{id_rubrique}|oui)]
			[(#GET{kml}|oui)
			filtre.push('#INFO_TITRE{article,#ENV{id_article}}');]
			$('<span class="info_filtre">'+ filtre.join(", ") +' '+ close_filtre +'</span>')
				.insertBefore('#menu_moi')
				.hide().fadeIn(3500);
		};
		
		// panel de gestion des kml dans #navigation
		// overlay du kml si clique sur le checkbox correspondant
		$('#kml_panel input.kml:checkbox').each(function(i) {
			var id = $(this).attr('id');
			var kml = $(this).val();
			$(this).bind ('click',function(){
				if ($(this).attr('checked')) {
					if (typeof(markerCluster) != "undefined") {
						markerCluster.clearMarkers();
					}
					$('#kml_panel input#medias:checkbox').attr('checked',false);
					layers[id] = new L.KML(kml, {async: true});
					map.addLayer(layers[id]);
				} else {
					map.removeLayer(layers[id]);
				}
			});
		});
		$('#kml_panel input#medias:checkbox').click(function() {
			if ($(this).attr('checked')) {
				$.getJSON("#URL_PAGE{geol_markers.json}",
					function(data) {
						if (data){
							parseData(data,map);
						}
					}
				);
			} else {
				markerCluster.clearMarkers()
			}
		})[(#GET{kml}|?{".attr('checked',false);",";"})]
		
		//  deplier/replier le panel
		$('#kml_panel #toggle').click(function() {
			$('#kml_panel').toggleClass('replie');
			$('#kml_panel ul.liste-items').slideToggle();
		});
		
		// init de la carte
		if ($.browser.msie) {
			$(window).load(initMap);
			resizeMap();
		} else {
			resizeMap();
			initMap();
		};
		
		// window resize ?
		$(window).resize(function(){
			resizeMap();
		});
		
		// ajouter le bouton pour afficher/masquer le pied
		// puis le faire glisser hors de la fenetre au chargement
		$('#pied .conteneur').append('<div id="bouton"> </div>');
		var pied_h = $('#pied').height();
		$(window).load(function(){
			$('#pied').animate({"bottom": (0-pied_h)}, { duration: "slow" }).toggleClass('cache');
		});
		$('#bouton').toggle(
			function(){
				$('#pied').animate({"bottom": 0}, { duration: "slow" }).toggleClass('cache');
			},
			function(){
				$('#pied:not(.cache)').animate({"bottom": (0-pied_h)}, { duration: "slow" }).toggleClass('cache');
			}
		);
		
		// formulaire de recherche geocoding
		$("#formulaire_recherche form").submit(function(){
			var adresse = $("#recherche").attr("value");
			var geocoder = new L.Geocoder(function(result) {
				map.setView(result.point, map.getZoom());
			});
			geocoder.geocode(adresse);
			return false;
		});
	})
})(jQuery)
// -->
</script>
<script type="text/javascript">
<!--
(function($){
	$(function(){

		// <BOUCLE_gis(GIS){id_article}>
		// centrer sur l'article passe dans l'url
		// #SET{lat,#LAT} #SET{lon,#LON} #SET{zoom,#ZOOM}
		// </BOUCLE_gis>
		[(#REM) Sinon centrer sur les coordonnes passees en parametre ou sur celle par defaut ]
		[(#GET{lat}|non)
		#SET{lat,#ENV{lat,#CONFIG**{gis/lat,0}}}]
		[(#GET{lon}|non)
		#SET{lon,#ENV{lon,#CONFIG**{gis/lon,0}}}]
		[(#GET{zoom}|non)
		#SET{zoom, #ENV{zoom,#CONFIG**{gis/zoom,0}}]
		
		var infowindow, maptype_maxzoom;
		var layers = new Array();

		var parseData = function(data,map) {
			markers = [];
			$.each(data.features, function(i,item){
				if (item.geometry.coordinates[0]) {
					var latlng = new google.maps.LatLng(item.geometry.coordinates[1],item.geometry.coordinates[0]);
					var marker = new google.maps.Marker({
						position: latlng,
						title:item.properties.name
					});
					if (item.properties.icon) {
						icon = new google.maps.MarkerImage();
						icon.url = item.properties.icon;
						icon.size = new google.maps.Size(32,32);
						icon.anchor = new google.maps.Point(16,16);
						marker.setIcon(icon);
					}
					marker.id = item.id;
					markers.push(marker);
				}
			});
			var styles = [{
					url: '#CHEMIN{images/bg_cluster.png}',
					height: 40,
					width: 40,
					textColor: '#ffffff'
				}];
			markerCluster = new MarkerClusterer(map, markers, {styles: styles});
			
			// préparer les infowindows
			var infowindow_options = {
				closeBoxURL: '[(#CHEMIN{images/infowindow_close.png})]',
				boxClass: 'geol_window',
				alignBottom: true,
				disableAutoPan: false,
				pixelOffset: new google.maps.Size(-120, 0),
				maxWidth: 350
			};
			var infowindow = new InfoBox(infowindow_options);
			var extUrl = "[(#URL_PAGE{get_infowindow})]";
			
			var get_infowindow = function(url,ids,infowindow,marker,map) {
				$.ajax({
					url: url,
					data: { id_article : ids },
					success: function(data){
						infowindow.setContent(data);
						infowindow.open(map,marker);
						infowindow.draw();
					}
				});
			};
			
			$.each(markers,function(i,marker){
				[// ouvrir l'infowindow du marker passé dans l'url
				if (marker.id=='(#ENV{id_article})') {
					get_infowindow(extUrl,#ENV{id_article},infowindow,marker,map);
				}]
				google.maps.event.addListener(marker, 'click', function() {
					if (infowindow) infowindow.close();
					get_infowindow(extUrl,marker.id,infowindow,marker,map);
				});
			});
			
			// lors du  clic sur un cluster
			google.maps.event.addListener(markerCluster, "click", function (cluster) {
				var markers = cluster.getMarkers();
				if (markers.length > 1) {
					// récupérer le zoom maxi de la carte
					if (map.getMapTypeId() == 'satellite' || map.getMapTypeId() == 'hybrid') {
						(new google.maps.MaxZoomService()).getMaxZoomAtLatLng(cluster.getCenter(), function(response) {
							if (response.status != google.maps.MaxZoomStatus.OK) {
								alert("Error in MaxZoomService");
								return;
							} else {
								maptype_maxzoom = response.zoom;
							}
						});
					} else {
						maptype_maxzoom =  map.mapTypes[map.getMapTypeId()].maxZoom;
					}
					// si on est au zoom maxi de la carte
					if (maptype_maxzoom <= map.getZoom()) {
						// récupérer les id des markers du cluster
						var markers_ids = new Array();
						$.each(markers,function(i,marker){
							markers_ids.push(marker.id);
						});
						// créer un point auquel on va attacher notre infowindow
						var marker = new google.maps.Marker({ position: cluster.getCenter() });
						// et ouvrir une infowindow multiple
						get_infowindow(extUrl,markers_ids,infowindow,marker,map);
					}
				}
			});
		};

		var initMap = function() {
			// création de la carte avec mapstraction
			var map_container = 'geomap';
			mxn_map = new mxn.Mapstraction(map_container,'#CONFIG{gis/api,openlayers}');
			[(#SET{maptype, #REM|gis_maptype_utilise})]
			mxn_map.setMapType([mxn.Mapstraction.(#GET{maptype})]);
			// on récupère l'objet de la carte google
			map = mxn_map.maps.googlev3;
			// et hop la suite en google maps api
			var map_options = {
				zoom: #GET{zoom},
				center: new google.maps.LatLng(#GET{lat},#GET{lon}),
				scrollwheel: true,
				panControl: false,
				zoomControl: true,
				scaleControl: true,
				mapTypeControl: true,
				mapTypeControlOptions: {
					position: google.maps.ControlPosition.TOP_LEFT
				},
				zoomControlOptions: {
					position: google.maps.ControlPosition.LEFT_TOP
				}
			}
			map.setOptions(map_options);
			
			// fermer l'infowindow au chagenement de zoom
			google.maps.event.addListener(map, 'zoom_changed', function() {
				if (infowindow) infowindow.close();
			});

			// <BOUCLE_kml(ARTICLES documents_liens documents){id_article}{mode=document}{documents.extension IN 'kml','kmz'}>
			// superposer le kml de l'article passe en url
			layers['kml_#ID_ARTICLE'] = new google.maps.KmlLayer("[(#URL_DOCUMENT|url_absolue)]");
			layers['kml_#ID_ARTICLE'].setMap(map);
			#SET{kml,oui}
			// </BOUCLE_kml>
			
			// charger les markers sauf si on superpose un kml
			[(#GET{kml}|non)
			$.getJSON("#PRODUIRE{fond=geol_markers.json,id_auteur=#ENV{id_auteur},id_mot=#ENV{id_mot},id_rubrique=#ENV{id_rubrique}}",
				function(data) {
					if (data){
						parseData(data,map);
					}
				}
			);
			]
			
			[(#ENV{id_auteur}|oui|ou{#ENV{id_mot}|oui}|ou{#ENV{id_rubrique}|ou{#GET{kml}|oui}|oui})
			// carte filtree
			infoFilter();
			]
		};
		
		// resize la carte si chgt de taille sur window
		var resizeMap = function() {
			var top_h = $('#top').height();
			var page_h = $('#page').height();
			$('#geomap').height(page_h - top_h);
		};
		
		// afficher un message si la carte est filtrée sur un ou plusieurs id
		var infoFilter = function() {
			var close_filtre = '<a href="#URL_PAGE{carte}" id="close_filtre" title="<:geol:recherche_retirer_filtre|attribut_html:>"><:geol:annuler:></a>';
			var filtre = new Array();
			[filtre.push('#INFO_NOM{auteur,#ENV{id_auteur}}');(#ENV{id_auteur}|oui)]
			[filtre.push('#INFO_TITRE{mot,#ENV{id_mot}}');(#ENV{id_mot}|oui)]
			[filtre.push('#INFO_TITRE{rubrique,#ENV{id_rubrique}}');(#ENV{id_rubrique}|oui)]
			[(#GET{kml}|oui)
			filtre.push('#INFO_TITRE{article,#ENV{id_article}}');]
			$('<span class="info_filtre">'+ filtre.join(", ") +' '+ close_filtre +'</span>')
				.insertBefore('#menu_moi')
				.hide().fadeIn(3500);
		};
		
		// panel de gestion des kml dans #navigation
		// overlay du kml si clique sur le checkbox correspondant
		$('#kml_panel input.kml:checkbox').each(function(i) {
			var id = $(this).attr('id');
			var kml = $(this).val();
			$(this).bind ('click',function(){
				if ($(this).attr('checked')) {
					if (typeof(markerCluster) != "undefined") {
						markerCluster.clearMarkers();
					}
					$('#kml_panel input#medias:checkbox').attr('checked',false);
					layers[id] = new google.maps.KmlLayer(kml);
					layers[id].setMap(map);
				} else {
					layers[id].setMap(null);
				}
			});
		});
		$('#kml_panel input#medias:checkbox').click(function() {
			if ($(this).attr('checked')) {
				$.getJSON("#URL_PAGE{geol_markers.json}",
					function(data) {
						if (data){
							parseData(data,map);
						}
					}
				);
			} else {
				markerCluster.clearMarkers()
			}
		})[(#GET{kml}|?{".attr('checked',false);",";"})]
		
		//  deplier/replier le panel
		$('#kml_panel #toggle').click(function() {
			$('#kml_panel').toggleClass('replie');
			$('#kml_panel ul.liste-items').slideToggle();
		});
		// panel draggable
		$('#kml_panel').draggable({
			containment: '#contenu',
			handle: 'h3'
		});
		
		// init de la carte
		if ($.browser.msie) {
			$(window).load(initMap);
			resizeMap();
		} else {
			resizeMap();
			initMap();
		};
		
		// window resize ?
		$(window).resize(function(){
			resizeMap();
		});
		
		// ajouter le bouton pour afficher/masquer le pied
		// puis le faire glisser hors de la fenetre au chargement
		$('#pied .conteneur').append('<div id="bouton"> </div>');
		var pied_h = $('#pied').height();
		$(window).load(function(){
			$('#pied').animate({"bottom": (0-pied_h)}, { duration: "slow" }).toggleClass('cache');
		});
		$('#bouton').toggle(
			function(){
				$('#pied').animate({"bottom": 0}, { duration: "slow" }).toggleClass('cache');
			},
			function(){
				$('#pied:not(.cache)').animate({"bottom": (0-pied_h)}, { duration: "slow" }).toggleClass('cache');
			}
		);
		
		// formulaire de recherche geocoding
		$("#formulaire_recherche form").submit(function(){
			var adresse = $("#recherche").attr("value");
			var geocoder = new google.maps.Geocoder();
			if (geocoder) {
				geocoder.geocode({'address': adresse }, function(result, status) {
					if (status != google.maps.GeocoderStatus.OK) {
						alert(adresse + " not found");
					} else {
						map.setCenter(result[0].geometry.location);
					}
				});
			}
			return false;
		});
	})
})(jQuery)
// -->
</script>